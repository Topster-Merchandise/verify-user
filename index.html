<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <title>Verify User</title>
</head>
<body>
    <div id="loading-spinner" class="fixed inset-0 z-10 flex items-center justify-center bg-white">
        <div class="relative flex justify-center items-center">
            <img id="status-image" src="https://lh5.googleusercontent.com/d/1ei4Ylj32g5QEFOanStFh37da2W0FWgg4" class="w-48 h-48" alt="Loading..." />
        </div>
    </div>

    <script>
        // --- ค่าคงที่: ทำให้ง่ายต่อการแก้ไขในอนาคต ---
        const LIFF_ID = '2007107416-MlWjQ44e';
        const GOOGLE_SHEET_URL = 'https://sheets.googleapis.com/v4/spreadsheets/1DfOrq6ronxmBIa6ImWdvhG5D9Q0wKkk5cAc6eXGHnzk/values/User_Control?alt=json&key=AIzaSyDQM3acD-wSUNh0uYb9vZiRgY70GHvTjHw';
        
        // --- รูปภาพสำหรับสถานะต่างๆ ---
        const IMAGE_LOADING = 'https://lh5.googleusercontent.com/d/1ei4Ylj32g5QEFOanStFh37da2W0FWgg4';
        const IMAGE_UNAUTHORIZED = 'https://lh5.googleusercontent.com/d/1zoHmtjKLxB8EpfPb708f-eUHEDyg8g1T';

        /**
         * ตรวจสอบสิทธิ์ผู้ใช้จาก Google Sheet
         * @param {string} userId - ไอดีผู้ใช้จาก LINE
         * @returns {Promise<boolean>} - คืนค่า true หากมีสิทธิ์, มิฉะนั้น false
         */
        async function verifyUser(userId) {
            try {
                const response = await fetch(GOOGLE_SHEET_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                const values = data.values;

                if (!values || values.length < 2) {
                    console.warn("No user data found in the sheet.");
                    return false;
                }

                const userPermissions = new Map();
                for (let i = 1; i < values.length; i++) {
                    const row = values[i];
                    if (row && row[1]) {
                        userPermissions.set(row[1], row[8]);
                    }
                }

                const permission = userPermissions.get(userId);
                return permission === "Access";

            } catch (error) {
                console.error("Error fetching or processing user data:", error);
                return false; 
            }
        }

        /**
         * แสดงผลเมื่อไม่ได้รับอนุญาต
         */
        function handleUnauthorizedAccess() {
            const img = document.getElementById("status-image");
            img.src = IMAGE_UNAUTHORIZED;
            img.classList.remove("w-48", "h-48");
            img.classList.add("w-64", "h-auto");

            setTimeout(() => {
                liff.closeWindow();
            }, 3000);
        }
        
        /**
         * ฟังก์ชันหลักในการทำงานของ LIFF App
         */
        async function main() {
            try {
                await liff.init({ liffId: LIFF_ID });

                if (!liff.isLoggedIn()) {
                    const destinationUrl = window.location.href;
                    liff.login({ redirectUri: destinationUrl });
                    return; 
                }

                const profile = await liff.getProfile();
                const isAuthorized = await verifyUser(profile.userId);

                if (isAuthorized) {
                    const urlParams = new URLSearchParams(window.location.search);
                    const request = urlParams.get('request');
                    const barcode = urlParams.get('barcode');

                    let redirectUrl = '';

                    switch (request) {
                        case "ProductImageUpload":
                            redirectUrl = `https://topster-merchandise.github.io/product-image-upload/?userId=${profile.userId}`;
                            break;
                        case "ProductImage":
                            redirectUrl = `https://topster-merchandise.github.io/Product-Image/?barcode=${barcode}`;
                            break;
                        case "FindProduct":
                            redirectUrl = `https://liff.line.me/2007107416-3rabVAAg`;
                            break;
                        case "StoreData":
                            redirectUrl = `https://liff.line.me/2007107416-AlkBrdd5`;
                            break;
                    }
                    
                    window.location.replace(redirectUrl);

                } else {
                    handleUnauthorizedAccess();
                }
            } catch (error) {
                console.error("LIFF Main Error:", error);
                handleUnauthorizedAccess();
            }
        }

        // เริ่มการทำงาน
        main();
    </script>
</body>
</html>
